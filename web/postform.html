{{template "base" .}}

{{define "content"}}
<section class="post-form-section">
    <h1>Create New Post</h1>
    <form action="/postform/submit" method="post" id="postform" onsubmit="handlePost(event)">
        <div class="form-group">
            <label for="title">Title</label>
            <textarea name="title" id="title" rows="2" required></textarea>
        </div>
        <div class="form-group">
            <label>Categories:</label>
            {{range .Categories}}
            <label class="lns-checkbox">
                <input type="checkbox" name="categories" value="{{.ID}}">
                <span>{{.Name}}</span>
            </label>
            {{end}}
        </div>

        <div class="form-group">
            <label for="content">Content</label>
            <textarea name="content" id="content" rows="10" required></textarea>
        </div>
        <button type="submit">Submit</button>
        <div id="error-message" class="error-message"></div>
    </form>
</section>
{{end}}

{{define "js"}}
<script>
    async function handlePost(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const formDataObject = Object.fromEntries(formData.entries());

        // Convert categories to an array of IDs
        const selectedCategories = Array.from(form.querySelectorAll('input[name="categories"]:checked'))
            .map(checkbox => parseInt(checkbox.value));

        if (selectedCategories.length === 0) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = 'Please select at least one category.';
            errorElement.style.display = 'block';
            return;
        }

        formDataObject.categories = selectedCategories;

        const response = await fetch('/postform/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formDataObject)
        });
        const result = await response.json();

        if (response.ok) {
            alert('Post it successfully');
            // redirect to the post
            window.location.href = '/post?id=' + result.message;
        } else {
            const errorMessage = result.message || 'Signup failed';
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        }
    }
</script>
{{end}}