{{template "base" .}}

{{define "content"}}
<section class="filter-section">
    <h2>Filter By Category</h2>
    <form id="filterForm" action="/filterCategory" method="POST">
        {{range .Categories}}
        <label class="lns-checkbox">
            <input type="checkbox" name="category" value="{{.ID}}">
            <span>{{.Name}}</span>
        </label>
        {{end}}
        <button type="submit">Filter</button>
    </form>
</section>

{{ if .LoggedIn }}
<section class="filter-section">
    <h2>Filter Posts</h2>
    <form id="filterLikesForm" action="/filterByLikes" method="GET">
        <label class="lns-checkbox">
            <input type="checkbox" name="showLiked" value="true">
            <span>Show Liked Posts</span>
        </label>
        <label class="lns-checkbox">
            <input type="checkbox" name="showCreated" value="true">
            <span>Show Created Posts</span>
        </label>
        <button type="submit">Filter</button>
    </form>
</section>
{{ end }}
<section class="posts-section">
    <h1>Forum Posts</h1>
    {{range .Posts}}
    <article class="post-card">
        <div id="post-{{.ID}}">
            <h2>{{.Title}}</h2>
            <p><strong>User:</strong> {{.Username}}</p>
            <p><strong>Content:</strong> {{.Content}}</p>
            <p><strong>Categories:</strong> {{range .Categories}}{{.Name}} {{end}}</p>
            <p><strong>Created At:</strong> {{.CreatedAt}}</p>
            <a href="/post?id={{.ID}}" class="button">Add comment</a>
            <button onclick="handleLike('post', '{{.ID}}', 'like')">Like</button>
            <span class="like-count">{{.Likes}}</span>
            <button onclick="handleLike('post', '{{.ID}}', 'dislike')">Dislike</button>
            <span class="dislike-count">{{.Dislikes}}</span>
        </div>
    </article>
    {{end}}
</section>


{{end}}
{{define "js"}}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', async function(event) {
                event.preventDefault();
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);
                        window.location.href = '/';
                    } else {
                        alert('Logout failed: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        }
    });
    
    async function handleLike(entityType, entityId, likeType) {
        const response = await fetch('/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: likeType,
                id: parseInt(entityId),
                entityType: entityType
            })
        })
        const result = await response.json();
        const [likes, dislikes] = result.message.split(',').map(Number);
        if (response.ok) {
            const likeCount = document.querySelector(`#${entityType}-${entityId} .like-count`);
            likeCount.innerText = `${likes}`
            const dislikeCount = document.querySelector(`#${entityType}-${entityId} .dislike-count`);
            dislikeCount.innerText = `${dislikes}`
        } else {
            const errorMessage = result.message || 'failed';
            alert(errorMessage)
        }
    }
</script>
{{end}}
