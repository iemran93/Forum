{{template "base" .}}

{{define "extraBase"}}
<li><a href="" id="filterLink">Filter</a></li>
{{end}}

{{define "content"}}
<!-- filer -->
<div id="filterContainer" style="display: none;">
    <form action="/filter" method="get" id="filterForm">
        <div>
            {{range .Categories}}
            <input type="checkbox" id="{{.Name}}" name="categories" value="{{.Name}}">
            <label for="{{.Name}}"> {{.Name}}</label>
            {{end}}
        </div>
        {{ if .LoggedIn }}
        <input type="checkbox" id="crposts" name="byUser" value="crposts">
        <label for="crposts">Created posts</label>
        <input type="checkbox" id="likeposts" name="byUser" value="likeposts">
        <label for="likeposts">Liked posts</label>
        {{ end }}
        <br>
        <button type="submit">Filter</button>
        <button type="button" onclick="clearForm()">Clear</button>
    </form>
</div>

<section class="posts-section">
    <h1>Forum Posts</h1>
    {{range .Posts}}
    <article class="post-card">
        <div id="post-{{.ID}}">
            <h2>{{.Title}}</h2>
            <p><strong>User:</strong> {{.Username}}</p>
            <p><strong>Content:</strong> {{.Content}}</p>
            <p><strong>Categories:</strong> {{range .Categories}}{{.Name}} {{end}}</p>
            <p><strong>Created At:</strong> {{.CreatedAt}}</p>
            <a href="/post?id={{.ID}}" class="button">Add comment</a>
            <button onclick="handleLike('post', '{{.ID}}', 'like')">Like</button>
            <span class="like-count">{{.Likes}}</span>
            <button onclick="handleLike('post', '{{.ID}}', 'dislike')">Dislike</button>
            <span class="dislike-count">{{.Dislikes}}</span>
        </div>
    </article>
    {{end}}
</section>


{{end}}
{{define "js"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', async function (event) {
                event.preventDefault();
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);
                        window.location.href = '/';
                    } else {
                        alert('Logout failed: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        }

        document.getElementById('filterLink').addEventListener('click', function (e) {
            e.preventDefault(); // Prevent the default link behavior

            var filterContainer = document.getElementById('filterContainer');
            if (filterContainer.style.display === 'none') {
                filterContainer.style.display = 'block';
            } else {
                filterContainer.style.display = 'none';
            }
        });
    });

    async function handleLike(entityType, entityId, likeType) {
        const response = await fetch('/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: likeType,
                id: parseInt(entityId),
                entityType: entityType
            })
        })
        const result = await response.json();
        const [likes, dislikes] = result.message.split(',').map(Number);
        if (response.ok) {
            const likeCount = document.querySelector(`#${entityType}-${entityId} .like-count`);
            likeCount.innerText = `${likes}`
            const dislikeCount = document.querySelector(`#${entityType}-${entityId} .dislike-count`);
            dislikeCount.innerText = `${dislikes}`
        } else {
            const errorMessage = result.message || 'failed';
            alert(errorMessage)
        }
    }

    // clear button for the filter form
    function clearForm() {
        // reset the checkboxes and radio buttons
        document.getElementById("filterForm").reset();
    }
</script>
{{end}}