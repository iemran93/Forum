{{ template "base" .}}

{{ define "content"}}

<!-- display posts -->
{{range .Posts}}
<div class="post-card">
    <h2>{{.Title}}</h2>
    <p><strong>Post ID:</strong> {{.ID}}</p>
    <p><strong>User ID:</strong> {{.UserID}}</p>
    <p><strong>Username:</strong>{{.Username}}</p>
    <p><strong>Content:</strong> {{.Content}}</p>
    <p><strong>Categories:</strong> {{range .Categories}} {{.Name}} {{end}}</p>
    <p><strong>Created At:</strong> {{.CreatedAt}}</p>
</div>
<hr>

<!-- add comment -->
<div class="comment-section">
    <form action="/comment" method="post" id="addcomment" onsubmit="handleAddComment(event)">
        <input type="hidden" name="post_id" value="{{.ID}}">
        <textarea name="content" rows="5" cols="50" placeholder="Start typing here" required></textarea>
        <br>
        <button type="submit" class="comment-button">Add comment</button>
        <br>
        <div id="error-message" class="error-message" style="display:none;"></div>
    </form>
</div>
{{end}}

<!-- display comments -->
{{range .Comments}}
<div id="comment-{{.ID}}" class="post-card">
    <h3>{{.Username}}</h3>
    <p>{{.CreatedAt}}</p>
    <p>{{.Content}}</p>

    <button onclick="handleLike('comment', '{{.ID}}', 'like')" class="like-button">Like</button>
    <span class="like-count">{{.Likes}}</span>
    <button onclick="handleLike('comment', '{{.ID}}', 'dislike')" class="dislike-button">Dislike</button>
    <span class="dislike-count">{{.Dislikes}}</span>
</div>
<hr>
{{end}}

{{end}}

{{ define "js"}}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        async function handleAddComment(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const formDataObject = Object.fromEntries(formData.entries());

            const response = await fetch('/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formDataObject)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Comment added successfully');
                // redirect to the post
                window.location.href = '/post?id=' + formDataObject.post_id;
            } else {
                const errorMessage = result.message || 'failed';
                const errorElement = document.getElementById('error-message');
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
            }
        }

        const commentForm = document.getElementById('addcomment');
        if (commentForm) {
            commentForm.addEventListener('submit', handleAddComment);
        }
    });

    async function handleLike(entityType, entityId, likeType) {
        const response = await fetch('/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: likeType,
                id: parseInt(entityId),
                entityType: entityType
            })
        })
        const result = await response.json();
        const [likes, dislikes] = result.message.split(',').map(Number);
        if (response.ok) {
            const likeCount = document.querySelector(`#${entityType}-${entityId} .like-count`);
            likeCount.innerText = `${likes}`
            const dislikeCount = document.querySelector(`#${entityType}-${entityId} .dislike-count`);
            dislikeCount.innerText = `${dislikes}`
        } else {
            const errorMessage = result.message || 'failed';
            alert(errorMessage)
        }
    }
</script>
{{ end }}